{"ast":null,"code":"import _regeneratorRuntime from \"/Users/wubenqi/nebula-chat/telegram-react/node_modules/babel-preset-react-app/node_modules/@babel/runtime/regenerator\";\nimport _toArray from \"/Users/wubenqi/nebula-chat/telegram-react/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/toArray\";\nimport _asyncToGenerator from \"/Users/wubenqi/nebula-chat/telegram-react/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";\nimport _classCallCheck from \"/Users/wubenqi/nebula-chat/telegram-react/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/classCallCheck\";\nimport _createClass from \"/Users/wubenqi/nebula-chat/telegram-react/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/createClass\";\nimport _possibleConstructorReturn from \"/Users/wubenqi/nebula-chat/telegram-react/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/possibleConstructorReturn\";\nimport _getPrototypeOf from \"/Users/wubenqi/nebula-chat/telegram-react/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/getPrototypeOf\";\nimport _assertThisInitialized from \"/Users/wubenqi/nebula-chat/telegram-react/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/assertThisInitialized\";\nimport _inherits from \"/Users/wubenqi/nebula-chat/telegram-react/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/inherits\";\nvar _jsxFileName = \"/Users/wubenqi/nebula-chat/telegram-react/src/Components/Popup/EditMediaDialog.js\";\n\n/*\n *  Copyright (c) 2018-present, Evgeny Nadymov\n *\n * This source code is licensed under the GPL v.3.0 license found in the\n * LICENSE file in the root directory of this source tree.\n */\nimport React from 'react';\nimport PropTypes from 'prop-types';\nimport { withTranslation } from 'react-i18next';\nimport Button from '@material-ui/core/Button';\nimport Dialog from '@material-ui/core/Dialog';\nimport DialogActions from '@material-ui/core/DialogActions';\nimport EditIcon from '@material-ui/icons/Edit';\nimport IconButton from '@material-ui/core/IconButton';\nimport FormControlLabel from '@material-ui/core/FormControlLabel';\nimport Radio from '@material-ui/core/Radio';\nimport RadioGroup from '@material-ui/core/RadioGroup';\nimport EditUrlDialog from './EditUrlDialog';\nimport { focusInput } from '../../Utils/DOM';\nimport { editMessage as editMessageAction } from '../../Actions/Client';\nimport { getEntities, getNodes } from '../../Utils/Message';\nimport { getMedia, getMediaPhotoFromFile } from '../../Utils/Media';\nimport MessageStore from '../../Stores/MessageStore';\nimport './EditMediaDialog.css';\n\nvar EditMediaDialog =\n/*#__PURE__*/\nfunction (_React$Component) {\n  _inherits(EditMediaDialog, _React$Component);\n\n  function EditMediaDialog(props) {\n    var _this;\n\n    _classCallCheck(this, EditMediaDialog);\n\n    _this = _possibleConstructorReturn(this, _getPrototypeOf(EditMediaDialog).call(this, props));\n\n    _this.handleSelectionChange = function () {\n      if (document.activeElement === _this.captionRef.current) {\n        _this.saveSelection();\n      }\n    };\n\n    _this.handleEnter = function () {\n      var _this$props = _this.props,\n          chatId = _this$props.chatId,\n          messageId = _this$props.messageId,\n          open = _this$props.open,\n          newItem = _this$props.newItem;\n      if (!open) return;\n      var text = null;\n      var caption = null;\n      var message = MessageStore.get(chatId, messageId);\n\n      if (message) {\n        var content = message.content;\n\n        if (content) {\n          text = content.text;\n          caption = content.caption;\n        }\n      }\n\n      var element = _this.captionRef.current;\n      if (!element) return;\n\n      if (text) {\n        _this.setFormattedText(text);\n      } else if (caption) {\n        _this.setFormattedText(caption);\n      } else if (newItem && newItem.caption) {\n        element.innerHTML = newItem.caption;\n      } else {\n        element.innerText = null;\n      }\n\n      focusInput(element);\n    };\n\n    _this.handleDone = function () {\n      var _this$props2 = _this.props,\n          chatId = _this$props2.chatId,\n          newItem = _this$props2.newItem,\n          onSend = _this$props2.onSend,\n          onEdit = _this$props2.onEdit;\n      var _this$state = _this.state,\n          editMessage = _this$state.editMessage,\n          editFile = _this$state.editFile,\n          editMedia = _this$state.editMedia,\n          sendAsPhoto = _this$state.sendAsPhoto;\n      var element = _this.captionRef.current;\n      if (!element) return;\n      var innerHTML = element.innerHTML;\n      element.innerText = null;\n\n      var _getEntities = getEntities(innerHTML),\n          text = _getEntities.text,\n          entities = _getEntities.entities;\n\n      var caption = {\n        '@type': 'formattedText',\n        text: text,\n        entities: entities\n      };\n      var isEditing = Boolean(editMessage);\n\n      if (isEditing) {\n        if (editMedia) {\n          var photo = editMedia.photo;\n          if (!photo) return;\n          var sizes = photo.sizes;\n          if (!sizes) return;\n          var size = sizes[sizes.length - 1];\n          var width = size.width,\n              height = size.height;\n          var content = {\n            '@type': 'inputMessagePhoto',\n            photo: {\n              '@type': 'inputFileBlob',\n              name: editFile.name,\n              data: editFile\n            },\n            width: width,\n            height: height,\n            caption: caption\n          };\n          onEdit(null, content);\n        } else {\n          onEdit(caption, null);\n        }\n\n        editMessageAction(chatId, 0);\n      } else {\n        var media = newItem.media,\n            file = newItem.file;\n        var audio = media.audio,\n            _photo = media.photo,\n            _document = media.document;\n        var _content = null;\n\n        if (_photo) {\n          var _sizes = _photo.sizes;\n          if (!_sizes) return;\n          var _size = _sizes[_sizes.length - 1];\n          var _width = _size.width,\n              _height = _size.height;\n          _content = sendAsPhoto ? {\n            '@type': 'inputMessagePhoto',\n            photo: {\n              '@type': 'inputFileBlob',\n              name: file.name,\n              data: file\n            },\n            width: _width,\n            height: _height,\n            caption: caption\n          } : {\n            '@type': 'inputMessageDocument',\n            document: {\n              '@type': 'inputFileBlob',\n              name: file.name,\n              data: file\n            },\n            thumbnail: null,\n            caption: caption\n          };\n        } else if (_document) {\n          _content = {\n            '@type': 'inputMessageDocument',\n            document: {\n              '@type': 'inputFileBlob',\n              name: file.name,\n              data: file\n            },\n            thumbnail: null,\n            caption: caption\n          };\n        } else if (audio) {\n          var duration = audio.duration,\n              title = audio.title,\n              performer = audio.performer;\n          _content = {\n            '@type': 'inputMessageAudio',\n            audio: {\n              '@type': 'inputFileBlob',\n              name: file.name,\n              data: file\n            },\n            thumbnail: null,\n            duration: duration,\n            title: title,\n            performer: performer,\n            caption: caption\n          };\n        }\n\n        if (!_content) return;\n        onSend(_content, file);\n      }\n    };\n\n    _this.handleCancel = function () {\n      var _this$props3 = _this.props,\n          chatId = _this$props3.chatId,\n          messageId = _this$props3.messageId,\n          onCancel = _this$props3.onCancel;\n      var message = MessageStore.get(chatId, messageId);\n      var isEditing = Boolean(message);\n\n      if (isEditing) {\n        editMessageAction(chatId, 0);\n      }\n\n      onCancel();\n    };\n\n    _this.handleKeyDown = function (event) {\n      var altKey = event.altKey,\n          ctrlKey = event.ctrlKey,\n          keyCode = event.keyCode,\n          metaKey = event.metaKey,\n          repeat = event.repeat,\n          shiftKey = event.shiftKey;\n\n      switch (keyCode) {\n        // enter\n        case 13:\n          {\n            if (!altKey && !ctrlKey && !metaKey && !shiftKey) {\n              if (!repeat) _this.handleDone();\n              event.preventDefault();\n              event.stopPropagation();\n            }\n\n            break;\n          }\n        // cmd + b\n\n        case 66:\n          {\n            if (!altKey && (ctrlKey || metaKey) && !shiftKey) {\n              if (!repeat) _this.handleBold();\n              event.preventDefault();\n              event.stopPropagation();\n            }\n\n            break;\n          }\n        // cmd + i\n\n        case 73:\n          {\n            if (!altKey && (ctrlKey || metaKey) && !shiftKey) {\n              if (!repeat) _this.handleItalic();\n              event.preventDefault();\n              event.stopPropagation();\n            }\n\n            break;\n          }\n\n        case 75:\n          {\n            // cmd + k\n            if (!altKey && (ctrlKey || metaKey) && !shiftKey) {\n              if (!repeat) _this.handleUrl();\n              event.preventDefault();\n              event.stopPropagation();\n            } // alt + cmd + k\n            else if (altKey && (ctrlKey || metaKey) && !shiftKey) {\n                if (!repeat) _this.handleMono();\n                event.preventDefault();\n                event.stopPropagation();\n              }\n\n            break;\n          }\n        // alt + cmd + n\n\n        case 192:\n          {\n            if (altKey && (ctrlKey || metaKey) && !shiftKey) {\n              if (!repeat) _this.handleClear();\n              event.preventDefault();\n              event.stopPropagation();\n            }\n\n            break;\n          }\n      }\n    };\n\n    _this.handleClear = function () {\n      document.execCommand('removeFormat', false, null);\n      document.execCommand('unlink', false, null);\n    };\n\n    _this.handleBold = function () {\n      document.execCommand('removeFormat', false, null);\n      document.execCommand('unlink', false, null);\n      document.execCommand('bold', false, null);\n    };\n\n    _this.handleItalic = function () {\n      document.execCommand('removeFormat', false, null);\n      document.execCommand('unlink', false, null);\n      document.execCommand('italic', false, null);\n    };\n\n    _this.handleMono = function () {\n      document.execCommand('removeFormat', false, null);\n      document.execCommand('unlink', false, null);\n      var text = '';\n\n      var _assertThisInitialize = _assertThisInitialized(_this),\n          selection = _assertThisInitialize.selection;\n\n      if (selection && !selection.isCollapsed) {\n        text = selection.toString();\n      }\n\n      if (!text) return;\n      text = \"<code>\".concat(text, \"</code>\");\n      document.execCommand('removeFormat', false, null);\n      document.execCommand('insertHTML', false, text);\n    };\n\n    _this.handleUnderline = function () {\n      document.execCommand('removeFormat', false, null);\n      document.execCommand('unlink', false, null);\n      document.execCommand('underline', false, null);\n    };\n\n    _this.handleStrikeThrough = function () {\n      document.execCommand('removeFormat', false, null);\n      document.execCommand('unlink', false, null);\n      document.execCommand('strikeThrough', false, null);\n    };\n\n    _this.handleUrl = function () {\n      _this.openEditUrlDialog();\n    };\n\n    _this.openEditUrlDialog = function () {\n      var defaultText = '';\n      var defaultUrl = '';\n\n      var _assertThisInitialize2 = _assertThisInitialized(_this),\n          selection = _assertThisInitialize2.selection,\n          range = _assertThisInitialize2.range;\n\n      if (range) {\n        var startContainer = range.startContainer,\n            endContainer = range.endContainer;\n\n        if (startContainer === endContainer) {\n          var parentElement = startContainer.parentElement;\n\n          if (parentElement && parentElement.nodeName === 'A') {\n            defaultText = parentElement.innerText;\n            defaultUrl = parentElement.href;\n          }\n        }\n      }\n\n      if (!defaultText && selection && !selection.isCollapsed) {\n        defaultText = selection.toString();\n      }\n\n      _this.setState({\n        openEditUrl: true,\n        defaultUrl: defaultUrl,\n        defaultText: defaultText\n      });\n    };\n\n    _this.closeEditUrlDialog = function () {\n      _this.setState({\n        openEditUrl: false\n      }, function () {\n        _this.restoreSelection();\n      });\n    };\n\n    _this.handlePaste = function (event) {\n      var plainText = event.clipboardData.getData('text/plain');\n\n      if (plainText) {\n        event.preventDefault();\n        document.execCommand('insertText', false, plainText);\n      }\n    };\n\n    _this.handleInput = function () {\n      _this.clearInnerHtml();\n    };\n\n    _this.handleCancelEditUrl = function () {\n      _this.closeEditUrlDialog();\n    };\n\n    _this.handleDoneEditUrl = function (text, url) {\n      _this.closeEditUrlDialog();\n\n      setTimeout(function () {\n        // edit current link node\n        var _assertThisInitialize3 = _assertThisInitialized(_this),\n            range = _assertThisInitialize3.range;\n\n        if (range) {\n          var startContainer = range.startContainer,\n              endContainer = range.endContainer;\n\n          if (startContainer && startContainer === endContainer) {\n            var parentNode = startContainer.parentNode;\n\n            if (parentNode && parentNode.nodeName === 'A') {\n              parentNode.href = url;\n              parentNode.title = url;\n              parentNode.innerText = text; // move cursor to end of editing node\n\n              var lastChild = parentNode.lastChild;\n\n              if (lastChild) {\n                var _range = document.createRange();\n\n                _range.setStart(lastChild, lastChild.textContent.length);\n\n                _range.setEnd(lastChild, lastChild.textContent.length);\n\n                var selection = document.getSelection();\n                selection.removeAllRanges();\n                selection.addRange(_range);\n              }\n\n              return;\n            }\n          }\n        } // replace selected text with new link node\n\n\n        var link = \"<a href=\".concat(url, \" title=\").concat(url, \" rel='noopener noreferrer' target='_blank'>\").concat(text, \"</a>\");\n        document.execCommand('removeFormat', false, null);\n        document.execCommand('insertHTML', false, link);\n      }, 0);\n    };\n\n    _this.handleEditMedia = function (event) {\n      var element = _this.editMediaRef.current;\n      if (!element) return;\n      element.click();\n    };\n\n    _this.handleEditMediaComplete =\n    /*#__PURE__*/\n    _asyncToGenerator(\n    /*#__PURE__*/\n    _regeneratorRuntime.mark(function _callee() {\n      var element, files, _Array$from, _Array$from2, file, rest, editMedia;\n\n      return _regeneratorRuntime.wrap(function _callee$(_context) {\n        while (1) {\n          switch (_context.prev = _context.next) {\n            case 0:\n              element = _this.editMediaRef.current;\n\n              if (element) {\n                _context.next = 3;\n                break;\n              }\n\n              return _context.abrupt(\"return\");\n\n            case 3:\n              files = element.files;\n\n              if (!(files.length === 0)) {\n                _context.next = 6;\n                break;\n              }\n\n              return _context.abrupt(\"return\");\n\n            case 6:\n              _Array$from = Array.from(files), _Array$from2 = _toArray(_Array$from), file = _Array$from2[0], rest = _Array$from2.slice(1);\n\n              if (file) {\n                _context.next = 9;\n                break;\n              }\n\n              return _context.abrupt(\"return\");\n\n            case 9:\n              _context.next = 11;\n              return getMediaPhotoFromFile(file);\n\n            case 11:\n              editMedia = _context.sent;\n\n              _this.setState({\n                editFile: file,\n                editMedia: editMedia\n              });\n\n              element.value = '';\n\n            case 14:\n            case \"end\":\n              return _context.stop();\n          }\n        }\n      }, _callee);\n    }));\n\n    _this.handleSendAsPhoto = function () {\n      var sendAsPhoto = _this.state.sendAsPhoto;\n\n      _this.setState({\n        sendAsPhoto: !sendAsPhoto\n      });\n    };\n\n    _this.captionRef = React.createRef();\n    _this.editMediaRef = React.createRef();\n    _this.state = {};\n    return _this;\n  }\n\n  _createClass(EditMediaDialog, [{\n    key: \"componentDidMount\",\n    value: function componentDidMount() {\n      document.addEventListener('selectionchange', this.handleSelectionChange, true);\n    }\n  }, {\n    key: \"componentWillUnmount\",\n    value: function componentWillUnmount() {\n      document.removeEventListener('selectionchange', this.handleSelectionChange, true);\n    }\n  }, {\n    key: \"setFormattedText\",\n    value: function setFormattedText(formattedText) {\n      var t = this.props.t;\n      var element = this.captionRef.current;\n\n      if (!formattedText) {\n        element.innerText = null;\n        return;\n      }\n\n      var text = formattedText.text,\n          entities = formattedText.entities;\n\n      try {\n        var nodes = getNodes(text, entities, t);\n        element.innerHTML = null;\n        nodes.forEach(function (x) {\n          element.appendChild(x);\n        });\n      } catch (e) {\n        element.innerText = text;\n      }\n    }\n  }, {\n    key: \"saveSelection\",\n    value: function saveSelection() {\n      this.selection = document.getSelection();\n      if (!this.selection) return;\n      if (!this.selection.rangeCount) return;\n      this.range = this.selection.getRangeAt(0);\n    }\n  }, {\n    key: \"restoreSelection\",\n    value: function restoreSelection() {\n      var range = this.range;\n\n      if (!range) {\n        focusInput();\n        return;\n      }\n\n      var selection = document.getSelection();\n      selection.removeAllRanges();\n      selection.addRange(range);\n      this.captionRef.current.focus();\n    }\n  }, {\n    key: \"clearInnerHtml\",\n    value: function clearInnerHtml() {\n      var element = this.captionRef.current;\n      if (!element) return;\n      var innerHTML = element.innerHTML;\n\n      if (innerHTML === '<br>' || innerHTML === '<div><br></div>') {\n        element.innerHTML = null;\n      }\n    }\n  }, {\n    key: \"render\",\n    value: function render() {\n      var _this$props4 = this.props,\n          chatId = _this$props4.chatId,\n          messageId = _this$props4.messageId,\n          newItem = _this$props4.newItem,\n          open = _this$props4.open,\n          t = _this$props4.t;\n      var _this$state2 = this.state,\n          defaultText = _this$state2.defaultText,\n          defaultUrl = _this$state2.defaultUrl,\n          openEditUrl = _this$state2.openEditUrl,\n          editMessage = _this$state2.editMessage,\n          editMedia = _this$state2.editMedia,\n          sendAsPhoto = _this$state2.sendAsPhoto;\n      if (!open) return null;\n      var message = MessageStore.get(chatId, messageId);\n      var isEditing = Boolean(message);\n      var isPhoto = false;\n\n      if (newItem && newItem.media && newItem.media['@type'] === 'messagePhoto') {\n        isPhoto = true;\n      } else if (editMedia && editMedia['@type'] === 'messagePhoto') {\n        isPhoto = true;\n      } else if (editMessage && editMessage.content['@type'] === 'messagePhoto') {\n        isPhoto = true;\n      }\n\n      var media = null;\n\n      if (isEditing) {\n        media = editMedia ? getMedia({\n          content: editMedia\n        }) : getMedia(message, null);\n      } else if (newItem) {\n        media = getMedia({\n          content: newItem.media\n        });\n      }\n\n      var doneLabel = isEditing ? t('Edit') : t('Send');\n      return React.createElement(Dialog, {\n        transitionDuration: 0,\n        open: true,\n        onClose: this.handleCancel,\n        \"aria-labelledby\": \"edit-media-dialog-title\",\n        onEnter: this.handleEnter,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 556\n        },\n        __self: this\n      }, React.createElement(\"div\", {\n        className: \"edit-media-dialog-content\",\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 562\n        },\n        __self: this\n      }, React.createElement(\"div\", {\n        style: {\n          margin: 24\n        },\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 563\n        },\n        __self: this\n      }, media), isEditing && React.createElement(React.Fragment, null, React.createElement(IconButton, {\n        disableRipple: true,\n        \"aria-label\": t('Edit'),\n        className: \"edit-media-dialog-edit-button\",\n        size: \"small\",\n        onClick: this.handleEditMedia,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 566\n        },\n        __self: this\n      }, React.createElement(EditIcon, {\n        fontSize: \"inherit\",\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 572\n        },\n        __self: this\n      })), React.createElement(\"input\", {\n        ref: this.editMediaRef,\n        className: \"inputbox-attach-button\",\n        type: \"file\",\n        accept: \"image/*\",\n        onChange: this.handleEditMediaComplete,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 574\n        },\n        __self: this\n      })), !isEditing && isPhoto && React.createElement(RadioGroup, {\n        value: sendAsPhoto,\n        onChange: this.handleSendAsPhoto,\n        style: {\n          margin: '0 24px 24px'\n        },\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 584\n        },\n        __self: this\n      }, React.createElement(FormControlLabel, {\n        value: true,\n        control: React.createElement(Radio, {\n          color: \"primary\",\n          __source: {\n            fileName: _jsxFileName,\n            lineNumber: 585\n          },\n          __self: this\n        }),\n        label: t('SendAsPhoto'),\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 585\n        },\n        __self: this\n      }), React.createElement(FormControlLabel, {\n        value: false,\n        control: React.createElement(Radio, {\n          color: \"primary\",\n          __source: {\n            fileName: _jsxFileName,\n            lineNumber: 586\n          },\n          __self: this\n        }),\n        label: t('SendAsFile'),\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 586\n        },\n        __self: this\n      }))), React.createElement(\"div\", {\n        ref: this.captionRef,\n        id: \"edit-media-dialog-caption\",\n        contentEditable: true,\n        suppressContentEditableWarning: true,\n        placeholder: t('Caption'),\n        onKeyDown: this.handleKeyDown,\n        onPaste: this.handlePaste,\n        onInput: this.handleInput,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 590\n        },\n        __self: this\n      }), React.createElement(DialogActions, {\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 600\n        },\n        __self: this\n      }, React.createElement(Button, {\n        onClick: this.handleCancel,\n        color: \"primary\",\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 601\n        },\n        __self: this\n      }, t('Cancel')), React.createElement(Button, {\n        onClick: this.handleDone,\n        color: \"primary\",\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 604\n        },\n        __self: this\n      }, doneLabel)), React.createElement(EditUrlDialog, {\n        open: openEditUrl,\n        defaultText: defaultText,\n        defaultUrl: defaultUrl,\n        onDone: this.handleDoneEditUrl,\n        onCancel: this.handleCancelEditUrl,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 608\n        },\n        __self: this\n      }));\n    }\n  }], [{\n    key: \"getDerivedStateFromProps\",\n    value: function getDerivedStateFromProps(props, state) {\n      var prevOpen = state.prevOpen;\n      var open = props.open,\n          chatId = props.chatId,\n          messageId = props.messageId,\n          newItem = props.newItem;\n\n      if (prevOpen !== open) {\n        if (open) {\n          var editMessage = MessageStore.get(chatId, messageId);\n          var sendAsPhoto = false;\n\n          if (editMessage && editMessage.content['@type'] === 'messagePhoto') {\n            sendAsPhoto = true;\n          } else if (newItem && newItem.media && newItem.media['@type'] === 'messagePhoto') {\n            sendAsPhoto = true;\n          }\n\n          return {\n            prevOpen: true,\n            sendAsPhoto: sendAsPhoto,\n            editMessage: editMessage,\n            editMedia: null,\n            editFile: null\n          };\n        } else {\n          return {\n            prevOpen: false,\n            sendAsPhoto: false,\n            editMessage: null,\n            editMedia: null,\n            editFile: null\n          };\n        }\n      }\n\n      return null;\n    }\n  }]);\n\n  return EditMediaDialog;\n}(React.Component);\n\nEditMediaDialog.propTypes = {\n  open: PropTypes.bool,\n  chatId: PropTypes.number,\n  messageId: PropTypes.number,\n  newItem: PropTypes.object,\n  onSend: PropTypes.func,\n  onEdit: PropTypes.func,\n  onCancel: PropTypes.func\n};\nexport default withTranslation()(EditMediaDialog);","map":{"version":3,"sources":["/Users/wubenqi/nebula-chat/telegram-react/src/Components/Popup/EditMediaDialog.js"],"names":["React","PropTypes","withTranslation","Button","Dialog","DialogActions","EditIcon","IconButton","FormControlLabel","Radio","RadioGroup","EditUrlDialog","focusInput","editMessage","editMessageAction","getEntities","getNodes","getMedia","getMediaPhotoFromFile","MessageStore","EditMediaDialog","props","handleSelectionChange","document","activeElement","captionRef","current","saveSelection","handleEnter","chatId","messageId","open","newItem","text","caption","message","get","content","element","setFormattedText","innerHTML","innerText","handleDone","onSend","onEdit","state","editFile","editMedia","sendAsPhoto","entities","isEditing","Boolean","photo","sizes","size","length","width","height","name","data","media","file","audio","thumbnail","duration","title","performer","handleCancel","onCancel","handleKeyDown","event","altKey","ctrlKey","keyCode","metaKey","repeat","shiftKey","preventDefault","stopPropagation","handleBold","handleItalic","handleUrl","handleMono","handleClear","execCommand","selection","isCollapsed","toString","handleUnderline","handleStrikeThrough","openEditUrlDialog","defaultText","defaultUrl","range","startContainer","endContainer","parentElement","nodeName","href","setState","openEditUrl","closeEditUrlDialog","restoreSelection","handlePaste","plainText","clipboardData","getData","handleInput","clearInnerHtml","handleCancelEditUrl","handleDoneEditUrl","url","setTimeout","parentNode","lastChild","createRange","setStart","textContent","setEnd","getSelection","removeAllRanges","addRange","link","handleEditMedia","editMediaRef","click","handleEditMediaComplete","files","Array","from","rest","value","handleSendAsPhoto","createRef","addEventListener","removeEventListener","formattedText","t","nodes","forEach","x","appendChild","e","rangeCount","getRangeAt","focus","isPhoto","doneLabel","margin","prevOpen","Component","propTypes","bool","number","object","func"],"mappings":"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","sourcesContent":["/*\n *  Copyright (c) 2018-present, Evgeny Nadymov\n *\n * This source code is licensed under the GPL v.3.0 license found in the\n * LICENSE file in the root directory of this source tree.\n */\n\nimport React from 'react';\nimport PropTypes from 'prop-types';\nimport { withTranslation } from 'react-i18next';\nimport Button from '@material-ui/core/Button';\nimport Dialog from '@material-ui/core/Dialog';\nimport DialogActions from '@material-ui/core/DialogActions';\nimport EditIcon from '@material-ui/icons/Edit';\nimport IconButton from '@material-ui/core/IconButton';\nimport FormControlLabel from '@material-ui/core/FormControlLabel';\nimport Radio from '@material-ui/core/Radio';\nimport RadioGroup from '@material-ui/core/RadioGroup';\nimport EditUrlDialog from './EditUrlDialog';\nimport { focusInput } from '../../Utils/DOM';\nimport { editMessage as editMessageAction } from '../../Actions/Client';\nimport { getEntities, getNodes } from '../../Utils/Message';\nimport { getMedia, getMediaPhotoFromFile } from '../../Utils/Media';\nimport MessageStore from '../../Stores/MessageStore';\nimport './EditMediaDialog.css';\n\nclass EditMediaDialog extends React.Component {\n    constructor(props) {\n        super(props);\n\n        this.captionRef = React.createRef();\n        this.editMediaRef = React.createRef();\n\n        this.state = {\n\n        };\n    }\n\n    static getDerivedStateFromProps(props, state) {\n        const { prevOpen } = state;\n        const { open, chatId, messageId, newItem } = props;\n\n        if (prevOpen !== open) {\n            if (open) {\n                const editMessage = MessageStore.get(chatId, messageId);\n                let sendAsPhoto = false;\n                if (editMessage && editMessage.content['@type'] === 'messagePhoto') {\n                    sendAsPhoto = true;\n                } else if (newItem && newItem.media && newItem.media['@type'] === 'messagePhoto'){\n                    sendAsPhoto = true;\n                }\n\n                return {\n                    prevOpen: true,\n                    sendAsPhoto,\n                    editMessage,\n                    editMedia: null,\n                    editFile: null\n                }\n            } else {\n                return {\n                    prevOpen: false,\n                    sendAsPhoto: false,\n                    editMessage: null,\n                    editMedia: null,\n                    editFile: null\n                }\n            }\n        }\n\n        return null;\n    }\n\n    componentDidMount() {\n        document.addEventListener('selectionchange', this.handleSelectionChange, true);\n    }\n\n    componentWillUnmount() {\n        document.removeEventListener('selectionchange', this.handleSelectionChange, true);\n    }\n\n    handleSelectionChange = () => {\n        if (document.activeElement === this.captionRef.current) {\n            this.saveSelection();\n        }\n    };\n\n    handleEnter = () => {\n        const { chatId, messageId, open, newItem } = this.props;\n        if (!open) return;\n\n        let text = null;\n        let caption = null;\n        const message = MessageStore.get(chatId, messageId);\n        if (message) {\n            const { content } = message;\n            if (content) {\n                text = content.text;\n                caption = content.caption;\n            }\n        }\n\n        const element = this.captionRef.current;\n        if (!element) return;\n\n        if (text) {\n            this.setFormattedText(text);\n        } else if (caption) {\n            this.setFormattedText(caption);\n        } else if (newItem && newItem.caption) {\n            element.innerHTML = newItem.caption;\n        } else {\n            element.innerText = null;\n        }\n\n        focusInput(element);\n    };\n\n    setFormattedText(formattedText) {\n        const { t } = this.props;\n        const element = this.captionRef.current;\n\n        if (!formattedText) {\n            element.innerText = null;\n            return;\n        }\n\n        const { text, entities } = formattedText;\n        try {\n            const nodes = getNodes(text, entities, t);\n            element.innerHTML = null;\n            nodes.forEach(x => {\n                element.appendChild(x);\n            });\n        } catch (e) {\n            element.innerText = text;\n        }\n    }\n\n    handleDone = () => {\n        const { chatId, newItem, onSend, onEdit } = this.props;\n        const { editMessage, editFile, editMedia, sendAsPhoto } = this.state;\n\n        const element = this.captionRef.current;\n        if (!element) return;\n\n        const { innerHTML } = element;\n\n        element.innerText = null;\n\n        const { text, entities } = getEntities(innerHTML);\n\n        const caption = {\n            '@type': 'formattedText',\n            text,\n            entities\n        };\n\n        const isEditing = Boolean(editMessage);\n        if (isEditing) {\n            if (editMedia) {\n                const { photo } = editMedia;\n                if (!photo) return;\n\n                const { sizes } = photo;\n                if (!sizes) return;\n\n                const size = sizes[sizes.length - 1];\n\n                const { width, height } = size;\n\n                const content = {\n                    '@type': 'inputMessagePhoto',\n                    photo: { '@type': 'inputFileBlob', name: editFile.name, data: editFile },\n                    width,\n                    height,\n                    caption\n                };\n\n                onEdit(null, content);\n            } else {\n                onEdit(caption, null);\n            }\n\n            editMessageAction(chatId, 0);\n        } else {\n            const { media, file } = newItem;\n            const { audio, photo, document } = media;\n\n            let content = null;\n            if (photo) {\n                const { sizes } = photo;\n                if (!sizes) return;\n\n                const size = sizes[sizes.length - 1];\n\n                const { width, height } = size;\n\n                content = sendAsPhoto\n                    ? {\n                        '@type': 'inputMessagePhoto',\n                        photo: { '@type': 'inputFileBlob', name: file.name, data: file },\n                        width,\n                        height,\n                        caption\n                    }\n                    : {\n                        '@type': 'inputMessageDocument',\n                        document: { '@type': 'inputFileBlob', name: file.name, data: file },\n                        thumbnail: null,\n                        caption\n                    };\n            } else if (document) {\n                content = {\n                    '@type': 'inputMessageDocument',\n                    document: { '@type': 'inputFileBlob', name: file.name, data: file },\n                    thumbnail: null,\n                    caption\n                };\n            } else if (audio) {\n                const { duration, title, performer } = audio;\n\n                content = {\n                    '@type': 'inputMessageAudio',\n                    audio: { '@type': 'inputFileBlob', name: file.name, data: file },\n                    thumbnail: null,\n                    duration,\n                    title,\n                    performer,\n                    caption\n                };\n            }\n            if (!content) return;\n\n            onSend(content, file);\n        }\n    };\n\n    handleCancel = () => {\n        const { chatId, messageId, onCancel } = this.props;\n\n        const message = MessageStore.get(chatId, messageId);\n        const isEditing = Boolean(message);\n\n        if (isEditing) {\n            editMessageAction(chatId, 0);\n        }\n\n        onCancel();\n    };\n\n    handleKeyDown = event => {\n        const { altKey, ctrlKey, keyCode, metaKey, repeat, shiftKey } = event;\n\n        switch (keyCode) {\n            // enter\n            case 13: {\n                if (!altKey && !ctrlKey && !metaKey && !shiftKey) {\n                    if (!repeat) this.handleDone();\n\n                    event.preventDefault();\n                    event.stopPropagation();\n                }\n                break;\n            }\n            // cmd + b\n            case 66: {\n                if (!altKey && (ctrlKey || metaKey) && !shiftKey) {\n                    if (!repeat) this.handleBold();\n\n                    event.preventDefault();\n                    event.stopPropagation();\n                }\n                break;\n            }\n            // cmd + i\n            case 73: {\n                if (!altKey && (ctrlKey || metaKey) && !shiftKey) {\n                    if (!repeat) this.handleItalic();\n\n                    event.preventDefault();\n                    event.stopPropagation();\n                }\n                break;\n            }\n            case 75: {\n                // cmd + k\n                if (!altKey && (ctrlKey || metaKey) && !shiftKey) {\n                    if (!repeat) this.handleUrl();\n\n                    event.preventDefault();\n                    event.stopPropagation();\n                }\n                // alt + cmd + k\n                else if (altKey && (ctrlKey || metaKey) && !shiftKey) {\n                    if (!repeat) this.handleMono();\n\n                    event.preventDefault();\n                    event.stopPropagation();\n                }\n                break;\n            }\n            // alt + cmd + n\n            case 192: {\n                if (altKey && (ctrlKey || metaKey) && !shiftKey) {\n                    if (!repeat) this.handleClear();\n\n                    event.preventDefault();\n                    event.stopPropagation();\n                }\n                break;\n            }\n        }\n    };\n\n    handleClear = () => {\n        document.execCommand('removeFormat', false, null);\n        document.execCommand('unlink', false, null);\n    };\n\n    handleBold = () => {\n        document.execCommand('removeFormat', false, null);\n        document.execCommand('unlink', false, null);\n\n        document.execCommand('bold', false, null);\n    };\n\n    handleItalic = () => {\n        document.execCommand('removeFormat', false, null);\n        document.execCommand('unlink', false, null);\n\n        document.execCommand('italic', false, null);\n    };\n\n    handleMono = () => {\n        document.execCommand('removeFormat', false, null);\n        document.execCommand('unlink', false, null);\n\n        let text = '';\n        const { selection } = this;\n        if (selection && !selection.isCollapsed) {\n            text = selection.toString();\n        }\n\n        if (!text) return;\n        text = `<code>${text}</code>`;\n        document.execCommand('removeFormat', false, null);\n        document.execCommand('insertHTML', false, text);\n    };\n\n    handleUnderline = () => {\n        document.execCommand('removeFormat', false, null);\n        document.execCommand('unlink', false, null);\n\n        document.execCommand('underline', false, null);\n    };\n\n    handleStrikeThrough = () => {\n        document.execCommand('removeFormat', false, null);\n        document.execCommand('unlink', false, null);\n\n        document.execCommand('strikeThrough', false, null);\n    };\n\n    handleUrl = () => {\n        this.openEditUrlDialog();\n    };\n\n    openEditUrlDialog = () => {\n        let defaultText = '';\n        let defaultUrl = '';\n\n        const { selection, range } = this;\n        if (range) {\n            let { startContainer, endContainer } = range;\n            if (startContainer === endContainer) {\n                const { parentElement } = startContainer;\n                if (parentElement && parentElement.nodeName === 'A') {\n                    defaultText = parentElement.innerText;\n                    defaultUrl = parentElement.href;\n                }\n            }\n        }\n\n        if (!defaultText && selection && !selection.isCollapsed) {\n            defaultText = selection.toString();\n        }\n\n        this.setState({\n            openEditUrl: true,\n            defaultUrl,\n            defaultText\n        });\n    };\n\n    closeEditUrlDialog = () => {\n        this.setState(\n            {\n                openEditUrl: false\n            },\n            () => {\n                this.restoreSelection();\n            }\n        );\n    };\n\n    saveSelection() {\n        this.selection = document.getSelection();\n        if (!this.selection) return;\n        if (!this.selection.rangeCount) return;\n\n        this.range = this.selection.getRangeAt(0);\n    }\n\n    restoreSelection() {\n        const { range } = this;\n\n        if (!range) {\n            focusInput();\n            return;\n        }\n\n        const selection = document.getSelection();\n        selection.removeAllRanges();\n        selection.addRange(range);\n\n        this.captionRef.current.focus();\n    }\n\n    handlePaste = event => {\n        const plainText = event.clipboardData.getData('text/plain');\n        if (plainText) {\n            event.preventDefault();\n            document.execCommand('insertText', false, plainText);\n        }\n    };\n\n    handleInput = () => {\n        this.clearInnerHtml();\n    };\n\n    clearInnerHtml() {\n        const element = this.captionRef.current;\n        if (!element) return;\n\n        const { innerHTML } = element;\n        if (innerHTML === '<br>' || innerHTML === '<div><br></div>') {\n            element.innerHTML = null;\n        }\n    }\n\n    handleCancelEditUrl = () => {\n        this.closeEditUrlDialog();\n    };\n\n    handleDoneEditUrl = (text, url) => {\n        this.closeEditUrlDialog();\n        setTimeout(() => {\n            // edit current link node\n            const { range } = this;\n            if (range) {\n                const { startContainer, endContainer } = range;\n                if (startContainer && startContainer === endContainer) {\n                    const { parentNode } = startContainer;\n                    if (parentNode && parentNode.nodeName === 'A') {\n                        parentNode.href = url;\n                        parentNode.title = url;\n                        parentNode.innerText = text;\n\n                        // move cursor to end of editing node\n                        const { lastChild } = parentNode;\n                        if (lastChild) {\n                            const range = document.createRange();\n                            range.setStart(lastChild, lastChild.textContent.length);\n                            range.setEnd(lastChild, lastChild.textContent.length);\n\n                            const selection = document.getSelection();\n                            selection.removeAllRanges();\n                            selection.addRange(range);\n                        }\n                        return;\n                    }\n                }\n            }\n\n            // replace selected text with new link node\n            const link = `<a href=${url} title=${url} rel='noopener noreferrer' target='_blank'>${text}</a>`;\n            document.execCommand('removeFormat', false, null);\n            document.execCommand('insertHTML', false, link);\n        }, 0);\n    };\n\n    handleEditMedia = event => {\n        const element = this.editMediaRef.current;\n        if (!element) return;\n\n        element.click();\n    };\n\n    handleEditMediaComplete = async () => {\n        const element = this.editMediaRef.current;\n        if (!element) return;\n\n        const { files } = element;\n        if (files.length === 0) return;\n\n        const [file, ...rest] = Array.from(files);\n        if (!file) return;\n\n        const editMedia = await getMediaPhotoFromFile(file);\n\n        this.setState({\n            editFile: file,\n            editMedia\n        });\n\n        element.value = '';\n    };\n\n    handleSendAsPhoto = () => {\n        const { sendAsPhoto } = this.state;\n\n        this.setState({\n            sendAsPhoto: !sendAsPhoto\n        });\n    };\n\n    render() {\n        const { chatId, messageId, newItem, open, t } = this.props;\n        const { defaultText, defaultUrl, openEditUrl, editMessage, editMedia, sendAsPhoto } = this.state;\n        if (!open) return null;\n\n        const message = MessageStore.get(chatId, messageId);\n        const isEditing = Boolean(message);\n        let isPhoto = false;\n        if (newItem && newItem.media && newItem.media['@type'] === 'messagePhoto') {\n            isPhoto = true;\n        } else if (editMedia && editMedia['@type'] === 'messagePhoto') {\n            isPhoto = true;\n        } else if (editMessage && editMessage.content['@type'] === 'messagePhoto'){\n            isPhoto = true;\n        }\n\n        let media = null;\n        if (isEditing) {\n            media =\n            editMedia\n                ? getMedia({ content: editMedia })\n                : getMedia(message, null);\n        } else if (newItem) {\n            media = getMedia({ content: newItem.media });\n        }\n        const doneLabel = isEditing ? t('Edit') : t('Send');\n\n        return (\n            <Dialog\n                transitionDuration={0}\n                open={true}\n                onClose={this.handleCancel}\n                aria-labelledby='edit-media-dialog-title'\n                onEnter={this.handleEnter}>\n                <div className='edit-media-dialog-content'>\n                    <div style={{ margin: 24 }}>{media}</div>\n                    { isEditing && (\n                        <>\n                            <IconButton\n                                disableRipple={true}\n                                aria-label={t('Edit')}\n                                className='edit-media-dialog-edit-button'\n                                size='small'\n                                onClick={this.handleEditMedia}>\n                                <EditIcon fontSize='inherit' />\n                            </IconButton>\n                            <input\n                                ref={this.editMediaRef}\n                                className='inputbox-attach-button'\n                                type='file'\n                                accept='image/*'\n                                onChange={this.handleEditMediaComplete}\n                            />\n                        </>\n                    )}\n                    { !isEditing && isPhoto && (\n                        <RadioGroup value={sendAsPhoto} onChange={this.handleSendAsPhoto} style={{ margin: '0 24px 24px' }}>\n                            <FormControlLabel value={true} control={<Radio color='primary'/>} label={t('SendAsPhoto')} />\n                            <FormControlLabel value={false} control={<Radio color='primary'/>} label={t('SendAsFile')} />\n                        </RadioGroup>\n                    )}\n                </div>\n                <div\n                    ref={this.captionRef}\n                    id='edit-media-dialog-caption'\n                    contentEditable\n                    suppressContentEditableWarning\n                    placeholder={t('Caption')}\n                    onKeyDown={this.handleKeyDown}\n                    onPaste={this.handlePaste}\n                    onInput={this.handleInput}\n                />\n                <DialogActions>\n                    <Button onClick={this.handleCancel} color='primary'>\n                        {t('Cancel')}\n                    </Button>\n                    <Button onClick={this.handleDone} color='primary'>\n                        {doneLabel}\n                    </Button>\n                </DialogActions>\n                <EditUrlDialog\n                    open={openEditUrl}\n                    defaultText={defaultText}\n                    defaultUrl={defaultUrl}\n                    onDone={this.handleDoneEditUrl}\n                    onCancel={this.handleCancelEditUrl}\n                />\n            </Dialog>\n        );\n    }\n}\n\nEditMediaDialog.propTypes = {\n    open: PropTypes.bool,\n\n    chatId: PropTypes.number,\n    messageId: PropTypes.number,\n    newItem: PropTypes.object,\n\n    onSend: PropTypes.func,\n    onEdit: PropTypes.func,\n    onCancel: PropTypes.func\n};\n\nexport default withTranslation()(EditMediaDialog);\n"]},"metadata":{},"sourceType":"module"}